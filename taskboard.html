<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Agent Task Board</title>
<style>
  :root {
    --bg:#0a0e1a; --s1:#111827; --s2:#1a2236; --s3:#212b42;
    --bd:#1e2d45; --tx:#e2e8f0; --mt:#64748b;
    --ac:#6366f1; --acg:rgba(99,102,241,.12);
    --ok:#10b981; --wr:#f59e0b; --er:#ef4444;
  }
  *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
  html,body{height:100%;background:var(--bg);color:var(--tx);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif}

  #hdr{height:54px;background:var(--s1);border-bottom:1px solid var(--bd);display:flex;align-items:center;padding:0 16px;gap:10px;flex-shrink:0}
  #logo{font-size:.92rem;font-weight:700;display:flex;align-items:center;gap:7px;white-space:nowrap}
  .dot{width:8px;height:8px;border-radius:50%;background:var(--ok);display:inline-block;animation:bk 2s infinite}
  @keyframes bk{0%,100%{opacity:1}50%{opacity:.3}}
  .chip{background:var(--s2);border:1px solid var(--bd);border-radius:16px;padding:2px 10px;font-size:.72rem;color:var(--mt);white-space:nowrap}
  .chip b{color:var(--tx)}
  .sp{flex:1}
  .btn{background:var(--s2);border:1px solid var(--bd);border-radius:8px;color:var(--mt);font-size:.78rem;padding:7px 12px;cursor:pointer;white-space:nowrap;transition:background .1s}
  .btn:hover,.btn:active{background:var(--bd);color:var(--tx)}
  .btn-p{background:var(--ac);color:#fff;border-color:var(--ac)}
  .btn-p:hover{background:#5558e6}

  /* Tabs */
  #tabs{display:flex;background:var(--s1);border-bottom:1px solid var(--bd);overflow-x:auto;flex-shrink:0}
  #tabs::-webkit-scrollbar{display:none}
  .tab{padding:10px 16px;font-size:.78rem;font-weight:600;color:var(--mt);cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;transition:color .1s}
  .tab:hover{color:var(--tx)}
  .tab.sel{color:var(--ac);border-bottom-color:var(--ac)}
  .tab .cnt{background:var(--s3);padding:1px 6px;border-radius:8px;font-size:.65rem;margin-left:4px}
  .tab.sel .cnt{background:var(--acg);color:var(--ac)}

  /* Board */
  #board{flex:1;display:flex;gap:12px;padding:12px;overflow-x:auto;overflow-y:hidden}
  #board::-webkit-scrollbar{height:4px}
  #board::-webkit-scrollbar-thumb{background:var(--bd);border-radius:4px}
  .col{min-width:260px;max-width:320px;flex:1;display:flex;flex-direction:column;overflow:hidden}
  .col-hdr{font-size:.72rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;padding:8px 12px;border-radius:8px 8px 0 0;display:flex;align-items:center;gap:6px;flex-shrink:0}
  .col-hdr .cnt{background:rgba(255,255,255,.1);padding:1px 7px;border-radius:10px;font-size:.6rem}
  .col-open .col-hdr{background:rgba(99,102,241,.15);color:#818cf8}
  .col-claimed .col-hdr{background:rgba(168,85,247,.15);color:#c084fc}
  .col-prog .col-hdr{background:rgba(245,158,11,.15);color:#fbbf24}
  .col-blocked .col-hdr{background:rgba(239,68,68,.15);color:#f87171}
  .col-done .col-hdr{background:rgba(16,185,129,.15);color:#34d399}
  .col-body{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:8px;padding:8px 0}
  .col-body::-webkit-scrollbar{width:3px}
  .col-body::-webkit-scrollbar-thumb{background:var(--bd)}

  /* Cards */
  .card{background:var(--s1);border:1px solid var(--bd);border-radius:8px;padding:10px 12px;cursor:pointer;transition:border-color .15s}
  .card:hover{border-color:var(--ac)}
  .card-title{font-size:.82rem;font-weight:500;line-height:1.3}
  .card-meta{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;align-items:center}
  .card-meta span{font-size:.62rem;color:var(--mt)}
  .tag{background:var(--s3);padding:1px 6px;border-radius:3px;font-size:.6rem;color:var(--mt)}
  .pri-urgent{border-left:3px solid var(--er)}
  .pri-high{border-left:3px solid var(--wr)}
  .pri-normal{border-left:3px solid var(--bd)}
  .pri-low{border-left:3px solid rgba(99,102,241,.3)}
  .dep-badge{background:rgba(239,68,68,.15);color:var(--er);padding:1px 5px;border-radius:3px;font-size:.58rem;font-weight:600}

  /* List view */
  #list{flex:1;overflow-y:auto;padding:12px;display:none}
  #list::-webkit-scrollbar{width:3px}
  #list::-webkit-scrollbar-thumb{background:var(--bd)}
  .list-row{background:var(--s1);border:1px solid var(--bd);border-radius:8px;padding:12px 16px;margin-bottom:8px;cursor:pointer;display:flex;align-items:center;gap:12px;transition:border-color .15s}
  .list-row:hover{border-color:var(--ac)}
  .list-status{width:10px;height:10px;border-radius:50%;flex-shrink:0}
  .st-open{background:#818cf8} .st-claimed{background:#c084fc} .st-in_progress{background:#fbbf24} .st-blocked{background:#f87171} .st-done{background:#34d399}
  .list-info{flex:1;min-width:0}
  .list-title{font-size:.84rem;font-weight:500}
  .list-sub{font-size:.68rem;color:var(--mt);margin-top:2px}

  /* Detail modal */
  .modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;align-items:center;justify-content:center;padding:16px}
  .modal-bg.show{display:flex}
  .modal{background:var(--s1);border:1px solid var(--bd);border-radius:12px;width:100%;max-width:600px;max-height:85vh;overflow-y:auto;padding:20px}
  .modal::-webkit-scrollbar{width:3px}
  .modal::-webkit-scrollbar-thumb{background:var(--bd)}
  .modal h2{font-size:1rem;margin-bottom:12px;color:var(--ac);display:flex;align-items:center;gap:8px}
  .modal .close{margin-left:auto;background:none;border:none;color:var(--mt);font-size:1.2rem;cursor:pointer;padding:4px 8px}
  .modal .close:hover{color:var(--tx)}
  .detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px}
  .detail-item{background:var(--s2);border-radius:6px;padding:8px 10px}
  .detail-label{font-size:.6rem;color:var(--mt);text-transform:uppercase;letter-spacing:.06em}
  .detail-val{font-size:.82rem;margin-top:2px}
  .comment{background:var(--s2);border-radius:6px;padding:8px 12px;margin-bottom:6px}
  .comment .author{font-size:.7rem;color:var(--ac);font-weight:600}
  .comment .body{font-size:.78rem;margin-top:3px;line-height:1.4}
  .comment .ts{font-size:.58rem;color:var(--mt)}
  .hist{font-size:.68rem;color:var(--mt);padding:4px 0;border-bottom:1px solid var(--bd)}
  .hist b{color:var(--tx)}
  .actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:12px}

  /* New task modal */
  .field{margin-bottom:10px}
  .field label{display:block;font-size:.68rem;color:var(--mt);margin-bottom:3px;text-transform:uppercase;letter-spacing:.04em}
  .field input,.field textarea,.field select{width:100%;background:var(--bg);border:1px solid var(--bd);color:var(--tx);padding:8px 10px;border-radius:6px;font-size:.82rem;font-family:inherit}
  .field textarea{min-height:60px;resize:vertical}
  .field input:focus,.field textarea:focus,.field select:focus{outline:none;border-color:var(--ac)}

  #fab{position:fixed;bottom:20px;right:20px;width:50px;height:50px;border-radius:50%;background:var(--ac);color:#fff;border:none;font-size:1.4rem;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.4);z-index:50;display:flex;align-items:center;justify-content:center}
  #fab:hover{background:#5558e6}

  #empty{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;color:var(--mt);gap:8px;font-size:.88rem;padding:40px}
  .eicon{font-size:2.6rem}

  @media(max-width:700px){
    .col{min-width:85vw;max-width:85vw;scroll-snap-align:start}
    #board{scroll-snap-type:x mandatory;padding:8px}
    .detail-grid{grid-template-columns:1fr}
    .modal{padding:16px}
    .chip.hide-m{display:none}
  }
</style>
</head>
<body>
<div id="hdr">
  <div id="logo">üóÇÔ∏è Tasks <span class="dot" id="sdot"></span></div>
  <div class="chip"><b id="s-total">-</b> tasks</div>
  <div class="chip hide-m"><b id="s-open">-</b> open</div>
  <div class="chip hide-m"><b id="s-prog">-</b> active</div>
  <div class="sp"></div>
  <button class="btn" onclick="loadAll()">‚Üª</button>
</div>
<div id="tabs">
  <div class="tab sel" data-v="board" onclick="switchView('board',this)">Board</div>
  <div class="tab" data-v="list" onclick="switchView('list',this)">List</div>
  <div class="tab" data-v="my" onclick="switchView('my',this)">My Tasks</div>
  <div class="tab" data-v="projects" onclick="switchView('projects',this)">Projects</div>
  <div class="tab" data-v="git" onclick="switchView('git',this)">Git</div>
</div>
<div id="board" style="display:flex">
  <div class="col col-open"><div class="col-hdr">Open <span class="cnt" id="c-open">0</span></div><div class="col-body" id="b-open"></div></div>
  <div class="col col-claimed"><div class="col-hdr">Claimed <span class="cnt" id="c-claimed">0</span></div><div class="col-body" id="b-claimed"></div></div>
  <div class="col col-prog"><div class="col-hdr">In Progress <span class="cnt" id="c-in_progress">0</span></div><div class="col-body" id="b-in_progress"></div></div>
  <div class="col col-blocked"><div class="col-hdr">Blocked <span class="cnt" id="c-blocked">0</span></div><div class="col-body" id="b-blocked"></div></div>
  <div class="col col-done"><div class="col-hdr">Done <span class="cnt" id="c-done">0</span></div><div class="col-body" id="b-done"></div></div>
</div>
<div id="list"></div>
<div id="projects-view" style="display:none;flex:1;overflow-y:auto;padding:12px"></div>
<div id="git-view" style="display:none;flex:1;overflow-y:auto;padding:12px"></div>
<div id="my-view" style="display:none;flex:1;overflow-y:auto;padding:12px"></div>
<button id="fab" onclick="showNew()">+</button>

<!-- Detail Modal -->
<div class="modal-bg" id="detailModal" onclick="if(event.target===this)closeDetail()">
  <div class="modal" id="detailBody"></div>
</div>

<!-- New Task Modal -->
<div class="modal-bg" id="newModal" onclick="if(event.target===this)closeNew()">
  <div class="modal">
    <h2>New Task <button class="close" onclick="closeNew()">‚úï</button></h2>
    <div class="field"><label>Title</label><input id="nt-title"/></div>
    <div class="field"><label>Description</label><textarea id="nt-desc"></textarea></div>
    <div class="field" style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div><label>Priority</label><select id="nt-pri"><option value="low">Low</option><option value="normal" selected>Normal</option><option value="high">High</option><option value="urgent">Urgent</option></select></div>
      <div><label>Assign To</label><input id="nt-assign" placeholder="Agent name"/></div>
    </div>
    <div class="field"><label>Tags (comma-separated)</label><input id="nt-tags" placeholder="infra, feature"/></div>
    <div class="field"><label>Effort Estimate</label><input id="nt-effort" placeholder="2h, 1d"/></div>
    <div class="actions">
      <button class="btn" onclick="closeNew()">Cancel</button>
      <button class="btn btn-p" onclick="createTask()">Create</button>
    </div>
  </div>
</div>

<script>
const B=window.location.pathname.includes('/bridge')?window.location.origin+'/bridge':window.location.origin;
let KEY=localStorage.getItem('tb_key')||'';

function api(p,o={}){
  const h={'Content-Type':'application/json',...o.headers};
  if(KEY)h['x-api-key']=KEY;
  return fetch(B+p,{...o,headers:h}).then(r=>{if(!r.ok)throw new Error(r.status);return r.json()})
}
function needKey(){
  if(KEY)return true;
  KEY=prompt('API Key (needed for actions):')||'';
  if(KEY){localStorage.setItem('tb_key',KEY);return true}
  return false;
}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function ago(t){const s=Date.now()/1000-t;if(s<60)return'just now';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago'}

function cardHtml(t){
  const tags=t.tags.map(g=>`<span class="tag">${esc(g)}</span>`).join('');
  const assign=t.claimed_by||t.assigned_to;
  return`<div class="card pri-${t.priority}" onclick="showDetail('${t.id}')">
    <div class="card-title">${esc(t.title)}</div>
    <div class="card-meta">
      <span>${t.priority}</span>
      ${assign?`<span>‚Üí ${esc(assign)}</span>`:''}
      ${tags}
      ${t.effort_estimate?`<span>‚è±${esc(t.effort_estimate)}</span>`:''}
    </div></div>`;
}

async function loadBoard(){
  try{
    const d=await api('/board');
    for(const[col,tasks]of Object.entries(d.board)){
      const el=document.getElementById('b-'+col);
      const cnt=document.getElementById('c-'+col);
      if(el)el.innerHTML=tasks.map(cardHtml).join('')||'<div style="text-align:center;color:var(--mt);font-size:.72rem;padding:16px">Empty</div>';
      if(cnt)cnt.textContent=tasks.length;
    }
  }catch(e){console.error(e)}
}

async function loadList(){
  try{
    const d=await api('/tasks?limit=100');
    const el=document.getElementById('list');
    el.innerHTML=d.tasks.map(t=>`<div class="list-row" onclick="showDetail('${t.id}')">
      <div class="list-status st-${t.status}"></div>
      <div class="list-info"><div class="list-title">${esc(t.title)}</div>
      <div class="list-sub">${t.status} ¬∑ ${t.priority} ¬∑ ${t.created_by}${t.claimed_by?' ‚Üí '+t.claimed_by:''}${t.effort_estimate?' ¬∑ ‚è±'+t.effort_estimate:''}</div></div>
    </div>`).join('')||'<div id="empty"><div class="eicon">üìã</div>No tasks yet</div>';
  }catch(e){console.error(e)}
}

async function loadMy(){
  try{
    const d=await api('/tasks/my/active');
    const el=document.getElementById('my-view');
    let h='<h3 style="font-size:.84rem;margin-bottom:8px;color:var(--ac)">Assigned to me</h3>';
    h+=d.assigned_to_me.map(t=>`<div class="list-row" onclick="showDetail('${t.id}')"><div class="list-status st-${t.status}"></div><div class="list-info"><div class="list-title">${esc(t.title)}</div><div class="list-sub">${t.status} ¬∑ ${t.priority}</div></div></div>`).join('')||'<div style="color:var(--mt);font-size:.78rem;padding:8px">None</div>';
    h+='<h3 style="font-size:.84rem;margin:16px 0 8px;color:var(--ac)">Created by me</h3>';
    h+=d.created_by_me.map(t=>`<div class="list-row" onclick="showDetail('${t.id}')"><div class="list-status st-${t.status}"></div><div class="list-info"><div class="list-title">${esc(t.title)}</div><div class="list-sub">${t.status} ¬∑ ${t.priority}</div></div></div>`).join('')||'<div style="color:var(--mt);font-size:.78rem;padding:8px">None</div>';
    el.innerHTML=h;
  }catch(e){console.error(e)}
}

async function loadProjects(){
  try{
    const d=await api('/projects');
    const el=document.getElementById('projects-view');
    el.innerHTML=d.projects.map(p=>{
      const tags=JSON.parse(p.tags||'[]').map(g=>`<span class="tag">${esc(g)}</span>`).join('');
      return`<div class="list-row" style="flex-direction:column;align-items:stretch;gap:6px">
        <div style="display:flex;align-items:center;gap:8px"><div class="list-title" style="flex:1">${esc(p.name)}</div>${tags}</div>
        <div class="list-sub">${p.task_count} tasks ¬∑ ${p.done_count} done ¬∑ ${p.progress_pct}% ¬∑ ${p.member_count} members</div>
        <div style="background:var(--bd);height:4px;border-radius:2px;overflow:hidden"><div style="background:var(--ok);height:100%;width:${p.progress_pct}%;transition:width .3s"></div></div>
      </div>`}).join('')||'<div id="empty"><div class="eicon">üìÅ</div>No projects yet</div>';
  }catch(e){console.error(e)}
}

async function loadGit(){
  try{
    const d=await api('/git/repos');
    const el=document.getElementById('git-view');
    if(!d.repos.length){el.innerHTML='<div id="empty"><div class="eicon">üîß</div>No repos yet</div>';return}
    let h='';
    for(const r of d.repos){
      h+=`<div class="list-row" style="flex-direction:column;align-items:stretch;gap:6px" onclick="showRepo('${esc(r.name)}')">
        <div class="list-title">üì¶ ${esc(r.name)}</div>
        <div class="list-sub">${r.commit_count} commits ¬∑ ${r.branch_count} branches ¬∑ by ${esc(r.created_by)}</div>
        ${r.description?`<div style="font-size:.72rem;color:var(--mt)">${esc(r.description)}</div>`:''}
      </div>`;
    }
    el.innerHTML=h;
  }catch(e){console.error(e)}
}

async function showRepo(name){
  try{
    const d=await api('/git/repos/'+encodeURIComponent(name));
    const tree=await api('/git/repos/'+encodeURIComponent(name)+'/tree');
    let h=`<h2 style="font-size:1rem;color:var(--ac);margin-bottom:12px">üì¶ ${esc(name)} <button class="close" onclick="loadGit()" style="margin-left:auto;background:none;border:none;color:var(--mt);cursor:pointer">‚Üê back</button></h2>`;
    h+=`<div style="font-size:.78rem;color:var(--mt);margin-bottom:16px">${esc(d.repo.description||'No description')}</div>`;
    h+='<h3 style="font-size:.78rem;color:var(--ac);margin-bottom:8px">Files</h3>';
    h+=tree.files.map(f=>`<div class="list-row" onclick="showFile('${esc(name)}','${esc(f.path)}')"><div style="font-size:.82rem">üìÑ ${esc(f.path)}</div><div class="list-sub" style="margin:0">${f.size}b</div></div>`).join('')||'<div style="color:var(--mt);font-size:.78rem">Empty</div>';
    h+='<h3 style="font-size:.78rem;color:var(--ac);margin:16px 0 8px">Recent Commits</h3>';
    h+=d.recent_commits.map(c=>`<div style="background:var(--s2);border-radius:6px;padding:8px 12px;margin-bottom:6px"><div style="font-size:.78rem">${esc(c.message)}</div><div style="font-size:.62rem;color:var(--mt)">${esc(c.author)} ¬∑ ${ago(c.created_at)}</div></div>`).join('');
    document.getElementById('git-view').innerHTML=h;
  }catch(e){console.error(e)}
}

async function showFile(repo,path){
  try{
    const d=await api('/git/repos/'+encodeURIComponent(repo)+'/files/'+path);
    const el=document.getElementById('detailBody');
    el.innerHTML=`<h2>üìÑ ${esc(path)} <button class="close" onclick="closeDetail()">‚úï</button></h2>
      <pre style="background:var(--bg);border:1px solid var(--bd);border-radius:6px;padding:12px;font-size:.78rem;overflow-x:auto;white-space:pre-wrap;word-break:break-word;line-height:1.5">${esc(d.content)}</pre>`;
    document.getElementById('detailModal').classList.add('show');
  }catch(e){console.error(e)}
}

async function showDetail(id){
  try{
    const d=await api('/tasks/'+id);
    const t=d.task;
    const deps=await api('/tasks/'+id+'/dependencies').catch(()=>({depends_on:[],blocks:[],unmet_blockers:0}));
    let h=`<h2>${esc(t.title)} <button class="close" onclick="closeDetail()">‚úï</button></h2>`;
    if(t.description)h+=`<div style="font-size:.82rem;line-height:1.5;margin-bottom:12px;white-space:pre-wrap">${esc(t.description)}</div>`;
    h+=`<div class="detail-grid">
      <div class="detail-item"><div class="detail-label">Status</div><div class="detail-val">${t.status}</div></div>
      <div class="detail-item"><div class="detail-label">Priority</div><div class="detail-val">${t.priority}</div></div>
      <div class="detail-item"><div class="detail-label">Created by</div><div class="detail-val">${esc(t.created_by)}</div></div>
      <div class="detail-item"><div class="detail-label">Owner</div><div class="detail-val">${esc(t.claimed_by||t.assigned_to||'Unassigned')}</div></div>
      ${t.effort_estimate?`<div class="detail-item"><div class="detail-label">Effort</div><div class="detail-val">${esc(t.effort_estimate)}</div></div>`:''}
      <div class="detail-item"><div class="detail-label">Updated</div><div class="detail-val">${ago(t.updated_at)}</div></div>
    </div>`;
    if(deps.depends_on.length){
      h+='<div style="margin-bottom:12px"><div style="font-size:.72rem;color:var(--mt);margin-bottom:4px">DEPENDS ON</div>';
      deps.depends_on.forEach(d=>h+=`<div style="font-size:.78rem;padding:4px 0"><span class="list-status st-${d.status}" style="display:inline-block;vertical-align:middle;margin-right:6px"></span>${esc(d.title)}</div>`);
      if(deps.unmet_blockers)h+=`<div class="dep-badge" style="margin-top:4px">${deps.unmet_blockers} unmet</div>`;
      h+='</div>';
    }
    if(deps.blocks.length){
      h+='<div style="margin-bottom:12px"><div style="font-size:.72rem;color:var(--mt);margin-bottom:4px">BLOCKS</div>';
      deps.blocks.forEach(d=>h+=`<div style="font-size:.78rem;padding:4px 0">${esc(d.title)}</div>`);
      h+='</div>';
    }
    if(d.subtasks.length){
      h+='<div style="margin-bottom:12px"><div style="font-size:.72rem;color:var(--mt);margin-bottom:4px">SUBTASKS</div>';
      d.subtasks.forEach(s=>h+=`<div class="list-row" style="margin-bottom:4px;padding:8px 12px" onclick="event.stopPropagation();showDetail('${s.id}')"><div class="list-status st-${s.status}"></div><div class="list-info"><div class="list-title">${esc(s.title)}</div></div></div>`);
      h+='</div>';
    }
    h+=`<div class="actions">`;
    if(t.status==='open')h+=`<button class="btn btn-p" onclick="taskAction('${t.id}','claim')">Claim</button>`;
    if(['open','claimed'].includes(t.status))h+=`<button class="btn btn-p" onclick="taskAction('${t.id}','start')">Start</button>`;
    if(!['done','cancelled'].includes(t.status))h+=`<button class="btn btn-p" onclick="taskAction('${t.id}','complete')">Complete</button>`;
    h+=`</div>`;
    if(d.comments.length){
      h+='<div style="margin-top:16px"><div style="font-size:.72rem;color:var(--mt);margin-bottom:6px">COMMENTS</div>';
      d.comments.forEach(c=>h+=`<div class="comment"><span class="author">${esc(c.agent_name)}</span> <span class="ts">${ago(c.created_at)}</span><div class="body">${esc(c.content)}</div></div>`);
      h+='</div>';
    }
    if(d.history.length){
      h+='<div style="margin-top:16px"><div style="font-size:.72rem;color:var(--mt);margin-bottom:6px">HISTORY</div>';
      d.history.forEach(e=>h+=`<div class="hist"><b>${esc(e.agent_name)}</b> ${esc(e.action)} ${ago(e.created_at)}</div>`);
      h+='</div>';
    }
    document.getElementById('detailBody').innerHTML=h;
    document.getElementById('detailModal').classList.add('show');
  }catch(e){console.error(e)}
}

async function taskAction(id,action){
  if(!needKey())return;
  await api('/tasks/'+id+'/'+action,{method:'POST'});
  closeDetail();loadAll();
}

async function loadStats(){
  try{
    const d=await api('/status');
    document.getElementById('s-total').textContent=d.tasks.total;
    document.getElementById('s-open').textContent=d.tasks.open;
    document.getElementById('s-prog').textContent=d.tasks.in_progress;
  }catch(e){}
}

function switchView(v,tab){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('sel'));
  tab.classList.add('sel');
  ['board','list','projects-view','git-view','my-view'].forEach(id=>{const el=document.getElementById(id);if(el)el.style.display='none'});
  if(v==='board'){document.getElementById('board').style.display='flex';loadBoard()}
  else if(v==='list'){document.getElementById('list').style.display='block';loadList()}
  else if(v==='my'){document.getElementById('my-view').style.display='block';loadMy()}
  else if(v==='projects'){document.getElementById('projects-view').style.display='block';loadProjects()}
  else if(v==='git'){document.getElementById('git-view').style.display='block';loadGit()}
}

function showNew(){document.getElementById('newModal').classList.add('show')}
function closeNew(){document.getElementById('newModal').classList.remove('show')}
function closeDetail(){document.getElementById('detailModal').classList.remove('show')}

async function createTask(){
  if(!needKey())return;
  const tags=document.getElementById('nt-tags').value.split(',').map(s=>s.trim()).filter(Boolean);
  await api('/tasks',{method:'POST',body:JSON.stringify({
    title:document.getElementById('nt-title').value,
    description:document.getElementById('nt-desc').value,
    priority:document.getElementById('nt-pri').value,
    assigned_to:document.getElementById('nt-assign').value||null,
    tags,effort_estimate:document.getElementById('nt-effort').value||null
  })});
  closeNew();
  ['nt-title','nt-desc','nt-tags','nt-assign','nt-effort'].forEach(id=>document.getElementById(id).value='');
  loadAll();
}

function loadAll(){loadStats();loadBoard()}
loadAll();
</script>
</body>
</html>
