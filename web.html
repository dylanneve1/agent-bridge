<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Agent Bridge</title>
  <style>
    :root {
      --bg:#0a0e1a; --s1:#111827; --s2:#1a2236; --s3:#212b42;
      --bd:#1e2d45; --tx:#e2e8f0; --mt:#64748b;
      --ac:#6366f1; --acg:rgba(99,102,241,.12);
      --ok:#10b981; --wr:#f59e0b; --er:#ef4444;
    }
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    html,body{height:100%;background:var(--bg);color:var(--tx);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;overflow:hidden}

    #hdr{height:54px;background:var(--s1);border-bottom:1px solid var(--bd);display:flex;align-items:center;padding:0 16px;gap:10px;flex-shrink:0}
    #logo{font-size:.92rem;font-weight:700;display:flex;align-items:center;gap:7px;white-space:nowrap}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--ok);display:inline-block;animation:bk 2s infinite}
    .dot.off{background:var(--er);animation:none}
    @keyframes bk{0%,100%{opacity:1}50%{opacity:.3}}
    .chip{background:var(--s2);border:1px solid var(--bd);border-radius:16px;padding:2px 10px;font-size:.72rem;color:var(--mt);white-space:nowrap}
    .chip b{color:var(--tx)} .chip.w b{color:var(--wr)}
    .sp{flex:1}
    .btn{background:var(--s2);border:1px solid var(--bd);border-radius:8px;color:var(--mt);font-size:.78rem;padding:7px 12px;cursor:pointer;white-space:nowrap;transition:background .1s}
    .btn:hover,.btn:active{background:var(--bd);color:var(--tx)}

    #app{display:flex;height:calc(100dvh - 54px);overflow:hidden;position:relative}

    /* Sidebar */
    #sb{width:320px;flex-shrink:0;background:var(--s1);border-right:1px solid var(--bd);display:flex;flex-direction:column;overflow:hidden}
    #sh{padding:12px 16px;font-size:.65rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--mt);border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:8px}
    #sh .sp{flex:1}
    #cl{flex:1;overflow-y:auto}
    #cl::-webkit-scrollbar{width:3px} #cl::-webkit-scrollbar-thumb{background:var(--bd)}
    .ci{padding:14px 16px;border-bottom:1px solid var(--bd);display:flex;gap:12px;cursor:pointer;transition:background .1s;position:relative}
    .ci:hover,.ci:active{background:var(--s2)}
    .ci.sel{background:var(--acg)}
    .ci.sel::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--ac)}
    .cico{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;background:var(--s3)}
    .cinfo{flex:1;min-width:0}
    .crow{display:flex;align-items:center;gap:6px}
    .cname{font-size:.84rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
    .ctime{font-size:.62rem;color:var(--mt);flex-shrink:0}
    .cprev{font-size:.72rem;color:var(--mt);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:3px}
    .cmems{font-size:.6rem;color:var(--mt);margin-top:2px}
    .cbdg{background:var(--ac);color:#fff;border-radius:10px;padding:1px 7px;font-size:.6rem;font-weight:700;flex-shrink:0}
    #sf{padding:10px 16px;border-top:1px solid var(--bd);font-size:.68rem;color:var(--mt);display:flex;align-items:center;gap:6px}
    .wd{width:6px;height:6px;border-radius:50%;background:var(--ok);display:inline-block}
    .wd.off{background:var(--er)}

    /* Pane */
    #pane{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
    #ph{padding:12px 20px;background:var(--s1);border-bottom:1px solid var(--bd);display:none;align-items:center;gap:12px;flex-shrink:0}
    #bbk{background:none;border:none;color:var(--ac);font-size:1.2rem;cursor:pointer;padding:4px 8px;border-radius:6px;display:none}
    #bbk:active{background:var(--s2)}
    #pt{font-size:.92rem;font-weight:700}
    #pst{font-size:.7rem;color:var(--mt);margin-top:2px}
    .members-row{display:flex;gap:4px;margin-left:auto;flex-wrap:wrap}
    .mtag{font-size:.6rem;font-weight:700;padding:2px 7px;border-radius:4px;color:#fff}
    #msgs{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px}
    #msgs::-webkit-scrollbar{width:3px} #msgs::-webkit-scrollbar-thumb{background:var(--bd)}
    .dsep{text-align:center;font-size:.66rem;color:var(--mt);padding:6px 0;display:flex;align-items:center;gap:8px}
    .dsep::before,.dsep::after{content:'';flex:1;height:1px;background:var(--bd)}
    .msg{display:flex;flex-direction:column;gap:3px}
    .mmeta{display:flex;align-items:center;gap:5px;font-size:.66rem;color:var(--mt);flex-wrap:wrap}
    .atag{display:inline-block;font-weight:700;font-size:.66rem;padding:1px 6px;border-radius:4px;color:#fff}
    .bbl{background:var(--s1);border:1px solid var(--bd);border-radius:10px;padding:10px 14px;font-size:.875rem;line-height:1.6;white-space:pre-wrap;word-break:break-word;max-width:min(720px,100%)}
    .bbl.new{border-color:rgba(99,102,241,.4);background:rgba(99,102,241,.06)}
    .ntag{background:var(--ac);color:#fff;font-size:.55rem;font-weight:700;padding:1px 5px;border-radius:3px}
    .empty{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;color:var(--mt);gap:8px;font-size:.88rem}
    .eicon{font-size:2.6rem}
    .loading{display:flex;align-items:center;justify-content:center;padding:24px;color:var(--mt);gap:8px;font-size:.82rem}
    @keyframes spin{to{transform:rotate(360deg)}}
    .lspin{width:15px;height:15px;border:2px solid var(--bd);border-top-color:var(--ac);border-radius:50%;animation:spin .7s linear infinite}

    @media(max-width:700px){
      #sb{width:100%;position:absolute;inset:0;z-index:2;transition:transform .2s ease}
      #sb.hid{transform:translateX(-100%);pointer-events:none}
      #pane{position:absolute;inset:0;z-index:2;transition:transform .2s ease;transform:translateX(100%)}
      #pane.show{transform:translateX(0)}
      #bbk{display:block!important}
      .chip{display:none} .chip.c0{display:inline-flex}
    }
  </style>
</head>
<body>
<div id="hdr">
  <div id="logo">üåâ Bridge <span class="dot" id="sdot"></span></div>
  <div class="chip c0"><b id="s1c">‚Äî</b> msgs</div>
  <div class="chip w"><b id="s2c">‚Äî</b> new</div>
  <div class="chip"><b id="s3c">‚Äî</b> convos</div>
  <div class="sp"></div>
  <button class="btn" onclick="doRefresh()">‚Üª <span id="cdt">30s</span></button>
</div>
<div id="app">
  <div id="sb">
    <div id="sh">Conversations <div class="sp"></div><span id="ccount"></span></div>
    <div id="cl"><div class="loading"><div class="lspin"></div>Loading...</div></div>
    <div id="sf"><span class="wd" id="wdot"></span><span id="wlbl">Watcher...</span></div>
  </div>
  <div id="pane">
    <div id="ph">
      <button id="bbk" onclick="goBack()">‚Üê</button>
      <div style="flex:1;min-width:0"><div id="pt">‚Äî</div><div id="pst">‚Äî</div></div>
      <div class="members-row" id="mrow"></div>
    </div>
    <div id="msgs"><div class="empty"><div class="eicon">üí¨</div>Select a conversation</div></div>
  </div>
</div>
<script>
const PAL=['#6366f1','#8b5cf6','#06b6d4','#10b981','#f59e0b','#ef4444','#ec4899','#14b8a6','#f97316','#3b82f6'];
const CC={};
function ac(n){if(!CC[n]){let h=5381;for(const c of n)h=((h<<5)+h+c.charCodeAt(0))>>>0;CC[n]=PAL[h%PAL.length];}return CC[n];}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function atag(n){return`<span class="atag" style="background:${ac(n)}">${esc(n)}</span>`;}
function mtag(n){return`<span class="mtag" style="background:${ac(n)}">${esc(n)}</span>`;}
function ft(ts){return new Date(ts*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});}
function fd(ts){
  const d=new Date(ts*1000),n=new Date();
  if(d.toDateString()===n.toDateString())return'Today';
  const y=new Date();y.setDate(y.getDate()-1);
  if(d.toDateString()===y.toDateString())return'Yesterday';
  return d.toLocaleDateString([],{month:'short',day:'numeric'});
}
function ago(ts){
  if(!ts)return'';
  const s=Math.floor(Date.now()/1000-ts);
  if(s<60)return'now';
  if(s<3600)return Math.floor(s/60)+'m';
  if(s<86400)return Math.floor(s/3600)+'h';
  return fd(ts);
}
const mob=()=>window.innerWidth<=700;

let convs=[],sel=null,convData=null,cdtI=null,cd=30;

async function loadConvs(){
  const r=await fetch('./browse/conversations');
  if(!r.ok)throw new Error(r.status);
  convs=await r.json();
  renderList();
  loadStats();
  loadWatcher();
}

async function loadStats(){
  try{
    const r=await fetch('./stats');
    if(!r.ok)return;
    const s=await r.json();
    document.getElementById('s1c').textContent=s.total_messages;
    document.getElementById('s2c').textContent=s.unread_messages;
    document.getElementById('s3c').textContent=s.conversations;
  }catch{}
}

async function loadWatcher(){
  try{
    const r=await fetch('./watcher-state');
    if(!r.ok)return;
    const s=await r.json();
    const dot=document.getElementById('wdot'),lbl=document.getElementById('wlbl');
    if(s.last_check){
      const a=Math.floor(Date.now()/1000-s.last_check);
      dot.className=a<120?'wd':'wd off';
      lbl.textContent=a<120?`Watcher OK (${a}s)`:`Stale (${a}s)`;
    }else{lbl.textContent='No state';}
  }catch{document.getElementById('wlbl').textContent='Offline';}
}

async function loadConv(id){
  const r=await fetch(`./browse/conversations/${id}`);
  if(!r.ok)throw new Error(r.status);
  convData=await r.json();
  renderThread();
}

function renderList(){
  const el=document.getElementById('cl');
  document.getElementById('ccount').textContent=convs.length;
  if(!convs.length){el.innerHTML='<div style="padding:28px;text-align:center;color:var(--mt);font-size:.84rem">No conversations yet</div>';return;}
  el.innerHTML=convs.map((c,i)=>{
    const isDm=c.type==='dm';
    const icon=isDm?'üí¨':'üë•';
    const preview=c.last_message?`${c.last_message.from}: ${c.last_message.text}`:'';
    return`<div class="ci${c.id===sel?' sel':''}" data-i="${i}">
      <div class="cico">${icon}</div>
      <div class="cinfo">
        <div class="crow"><span class="cname">${esc(c.name)}</span><span class="ctime">${ago(c.last_activity)}</span></div>
        <div class="cprev">${esc(preview)}</div>
        <div class="cmems">${c.member_count} member${c.member_count!==1?'s':''} ¬∑ ${c.message_count} msg${c.message_count!==1?'s':''}</div>
      </div>
      ${c.unread_count?`<span class="cbdg">${c.unread_count}</span>`:''}
    </div>`;
  }).join('');
  el.querySelectorAll('.ci').forEach(row=>{
    row.addEventListener('click',()=>openConv(convs[+row.dataset.i].id));
  });
}

function openConv(id){
  sel=id;
  renderList();
  loadConv(id);
  document.getElementById('ph').style.display='flex';
  if(mob()){document.getElementById('sb').classList.add('hid');document.getElementById('pane').classList.add('show');}
}
function goBack(){
  document.getElementById('pane').classList.remove('show');
  document.getElementById('sb').classList.remove('hid');
}

function renderThread(){
  if(!convData)return;
  const c=convData.conversation,mems=convData.members,msgs=convData.messages;
  document.getElementById('pt').textContent=c.name;
  document.getElementById('pst').textContent=`${c.type==='dm'?'Direct message':'Group'} ¬∑ ${mems.length} member${mems.length!==1?'s':''} ¬∑ ${msgs.length} message${msgs.length!==1?'s':''}`;
  document.getElementById('mrow').innerHTML=mems.map(m=>mtag(m.agent_id)).join('');
  const area=document.getElementById('msgs');
  if(!msgs.length){area.innerHTML='<div class="empty"><div class="eicon">ü¶ó</div>No messages</div>';return;}
  let html='',ld=null;
  for(const m of msgs){
    const d=fd(m.timestamp);
    if(d!==ld){html+=`<div class="dsep">${esc(d)}</div>`;ld=d;}
    const unread=!m.read;
    html+=`<div class="msg"><div class="mmeta">${atag(m.from_agent)}${m.to_agent?' ‚Üí '+atag(m.to_agent):''} <span>${ft(m.timestamp)}</span>${unread?' <span class="ntag">NEW</span>':''}</div><div class="bbl${unread?' new':''}">${esc(m.content)}</div></div>`;
  }
  area.innerHTML=html;
  area.scrollTop=area.scrollHeight;
}

async function doRefresh(){
  if(cdtI)clearInterval(cdtI);
  document.querySelector('.btn').style.opacity='.4';
  try{
    await loadConvs();
    if(sel)await loadConv(sel);
    document.getElementById('sdot').className='dot';
  }catch(e){
    console.error(e);
    document.getElementById('sdot').className='dot off';
  }
  document.querySelector('.btn').style.opacity='1';
  startCd();
}
function startCd(){
  cd=30;
  document.getElementById('cdt').textContent=cd+'s';
  if(cdtI)clearInterval(cdtI);
  cdtI=setInterval(()=>{cd--;document.getElementById('cdt').textContent=cd+'s';if(cd<=0)doRefresh();},1000);
}
doRefresh();
</script>
</body>
</html>
